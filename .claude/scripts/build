#!/usr/bin/env ruby

# Change to project root directory
Dir.chdir(File.expand_path('../..', __dir__))

# Load bundler and gems
require 'bundler/setup'

require 'fileutils'
require 'yaml'
require 'digest'
require 'date'
require 'kramdown'
require 'rouge'

# Build script for ikigai-devlog static site generator

CONTENT_DIR = 'content'
OUTPUT_DIR = 'public'
POSTS_PER_PAGE = 10
DIFF_THRESHOLD = 12

class Entry
  attr_accessor :type, :title, :slug, :published, :republished,
                :content, :html, :filepath, :last_build_hash, :last_build_lines

  def initialize(filepath, type)
    @filepath = filepath
    @type = type
    parse_file
  end

  def parse_file
    content = File.read(@filepath)

    # Extract frontmatter
    if content =~ /\A---\s*\n(.*?)\n---\s*\n(.*)/m
      frontmatter = YAML.safe_load($1, permitted_classes: [Date, Time])
      @content = $2

      @title = frontmatter['title']
      @slug = frontmatter['slug']
      @published = Date.parse(frontmatter['published'].to_s)
      @republished = frontmatter['republished'] || []
      @last_build_hash = frontmatter['last_build_hash'] || ''
      @last_build_lines = frontmatter['last_build_lines'] || 0

      # Convert markdown to HTML with syntax highlighting
      @html = Kramdown::Document.new(@content, {
        input: 'GFM',
        syntax_highlighter: :rouge,
        syntax_highlighter_opts: { css_class: 'highlight' }
      }).to_html
    else
      raise "Invalid frontmatter in #{@filepath}"
    end
  end

  def content_hash
    Digest::SHA256.hexdigest(@content)
  end

  def url
    if @type == 'page'
      "/#{@slug}/"
    else
      "/posts/#{@slug}/"
    end
  end

  # Generate feed items for this entry
  def feed_items
    items = [{
      date: @published,
      entry: self,
      is_update: false
    }]

    # Add republish entries (only for pages)
    if @type == 'page'
      @republished.each do |update|
        items << {
          date: Date.parse(update['date'].to_s),
          entry: self,
          is_update: true,
          update_summary: update['summary']
        }
      end
    end

    items
  end
end

def load_entries
  entries = []

  # Load posts
  Dir.glob("#{CONTENT_DIR}/posts/*.md").each do |filepath|
    entries << Entry.new(filepath, 'post')
  end

  # Load pages
  Dir.glob("#{CONTENT_DIR}/pages/*.md").each do |filepath|
    entries << Entry.new(filepath, 'page')
  end

  entries
end

def build_feed(entries)
  feed = []

  entries.each do |entry|
    feed.concat(entry.feed_items)
  end

  # Sort by date, newest first
  feed.sort_by { |item| item[:date] }.reverse
end

def layout(title, content, current_url: nil, prev_url: nil, next_url: nil)
  <<~HTML
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
      <meta http-equiv="Pragma" content="no-cache">
      <meta http-equiv="Expires" content="0">
      <title>#{title} - Ikigai Devlog</title>
      <link rel="stylesheet" href="/css/style.css">
      <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
      <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
    </head>
    <body>
      <header>
        <img src="/assets/profile.png" alt="Profile" class="profile-pic">
        <div class="header-text">
          <h1><a href="/">Ikigai Devlog</a></h1>
          <p class="subtitle">AI-assisted development journal</p>
        </div>
        <nav class="header-nav">
          <a href="https://github.com/mgreenly/ikigai" class="github-link">
            <svg class="github-icon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true">
              <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
            </svg>
            Ikigai on GitHub
          </a>
          <a href="/feed.xml" class="rss-link">
            <svg class="rss-icon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true">
              <path fill="currentColor" d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm1.5 12a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm0-5.5a1 1 0 0 1 0-2 5.5 5.5 0 0 1 5.5 5.5 1 1 0 0 1-2 0 3.5 3.5 0 0 0-3.5-3.5zm0-4a1 1 0 0 1 0-2 9.5 9.5 0 0 1 9.5 9.5 1 1 0 0 1-2 0 7.5 7.5 0 0 0-7.5-7.5z"/>
            </svg>
            RSS
          </a>
          <a href="https://www.youtube.com/@IkigaiDevlog" class="youtube-link">
            <svg class="youtube-icon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true">
              <path fill="currentColor" d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.007 2.007 0 0 1-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82l-.008-.104A31.4 31.4 0 0 1 0 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007 0 0 1 1.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788 0 0 1 7.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z"/>
            </svg>
            YouTube
          </a>
        </nav>
      </header>

      <main>
        #{content}
      </main>

      #{navigation_html(prev_url, next_url) if prev_url || next_url}

      <footer>
        #{current_url != '/' ? '<p><a href="/">Home</a></p>' : ''}
      </footer>
      <script>
        document.querySelectorAll('article a').forEach(function(link) {
          if (link.hostname !== window.location.hostname) {
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener');
          }
        });
      </script>
    </body>
    </html>
  HTML
end

def navigation_html(prev_url, next_url)
  <<~HTML
    <nav class="post-navigation">
      #{prev_url ? "<a href=\"#{prev_url}\" class=\"prev\">← Previous</a>" : '<span class="prev disabled">← Previous</span>'}
      #{next_url ? "<a href=\"#{next_url}\" class=\"next\">Next →</a>" : '<span class="next disabled">Next →</span>'}
    </nav>
  HTML
end

def generate_entry_page(entry, prev_entry: nil, next_entry: nil)
  output_dir = if entry.type == 'page'
    "#{OUTPUT_DIR}/#{entry.slug}"
  else
    "#{OUTPUT_DIR}/posts/#{entry.slug}"
  end

  FileUtils.mkdir_p(output_dir)

  content = <<~HTML
    <article>
      <h1>#{entry.title}</h1>
      <time datetime="#{entry.published}">#{entry.published.strftime('%B %d, %Y')}</time>

      #{entry.html}
    </article>
  HTML

  prev_url = prev_entry ? prev_entry.url : nil
  next_url = next_entry ? next_entry.url : nil

  html = layout(entry.title, content,
                current_url: entry.url,
                prev_url: prev_url,
                next_url: next_url)

  File.write("#{output_dir}/index.html", html)
end

def generate_index_page(feed, page_num = 1)
  start_idx = (page_num - 1) * POSTS_PER_PAGE
  items = feed[start_idx, POSTS_PER_PAGE] || []

  content = <<~HTML
    <div class="feed">
  HTML

  items.each do |item|
    entry = item[:entry]
    date_str = item[:date].strftime('%B %d, %Y')

    if item[:is_update]
      content += <<~HTML
        <article class="feed-item update">
          <h2><a href="#{entry.url}">#{entry.title}</a></h2>
          <time datetime="#{item[:date]}">Updated: #{date_str}</time>
          <p class="update-summary">#{item[:update_summary]}</p>
        </article>
      HTML
    else
      # Get first paragraph as summary
      summary = entry.html[/<p>(.*?)<\/p>/m, 1] || entry.html[0..200]

      content += <<~HTML
        <article class="feed-item">
          <h2><a href="#{entry.url}">#{entry.title}</a></h2>
          <time datetime="#{item[:date]}">#{date_str}</time>
          <p>#{summary}</p>
        </article>
      HTML
    end
  end

  content += "</div>\n"

  # Pagination
  total_pages = (feed.length.to_f / POSTS_PER_PAGE).ceil

  if total_pages > 1
    content += '<nav class="pagination">'

    if page_num > 1
      prev_page = page_num == 2 ? '/' : "/page-#{page_num - 1}.html"
      content += "<a href=\"#{prev_page}\">← Newer</a>"
    end

    content += " <span>Page #{page_num} of #{total_pages}</span> "

    if page_num < total_pages
      content += "<a href=\"/page-#{page_num + 1}.html\">Older →</a>"
    end

    content += '</nav>'
  end

  current_url = page_num == 1 ? '/' : "/page-#{page_num}.html"
  html = layout('Home', content, current_url: current_url)

  filename = page_num == 1 ? "#{OUTPUT_DIR}/index.html" : "#{OUTPUT_DIR}/page-#{page_num}.html"
  File.write(filename, html)
end

def generate_css
  FileUtils.mkdir_p("#{OUTPUT_DIR}/css")

  css = <<~CSS
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    p {
      margin-bottom: 1.2em;
    }

    header {
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 2px solid #eee;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 20px;
    }

    header .profile-pic {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      order: 2;
      margin-left: auto;
    }

    header .header-text {
      order: 1;
    }

    header h1 {
      font-size: 2em;
      margin-bottom: 5px;
    }

    header h1 a {
      color: #333;
      text-decoration: none;
    }

    header .subtitle {
      color: #666;
      font-style: italic;
    }

    header .header-nav {
      margin-top: 10px;
      font-size: 0.9em;
      order: 3;
      width: 100%;
    }

    header .header-nav .github-link {
      color: #0066cc;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    header .header-nav .github-link:hover {
      text-decoration: underline;
    }

    header .header-nav .github-icon {
      display: inline-block;
      vertical-align: middle;
    }

    header .header-nav .rss-link {
      color: #f26522;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-left: 15px;
    }

    header .header-nav .rss-link:hover {
      text-decoration: underline;
    }

    header .header-nav .rss-icon {
      display: inline-block;
      vertical-align: middle;
    }

    header .header-nav .youtube-link {
      color: #ff0000;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-left: 15px;
    }

    header .header-nav .youtube-link:hover {
      text-decoration: underline;
    }

    header .header-nav .youtube-icon {
      display: inline-block;
      vertical-align: middle;
    }

    main {
      margin-bottom: 40px;
    }

    article {
      margin-bottom: 40px;
    }

    article h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }

    article h2 {
      font-size: 1.5em;
      margin: 30px 0 5px 0;
    }

    article h3 {
      font-size: 1.25em;
      margin: 30px 0 5px 0;
    }

    article time {
      color: #666;
      font-size: 0.9em;
      display: block;
      margin-bottom: 20px;
    }

    .feed-item {
      margin-bottom: 30px;
      padding-bottom: 30px;
      border-bottom: 1px solid #eee;
    }

    .feed-item:last-child {
      border-bottom: none;
    }

    .feed-item h2 {
      margin: 0 0 10px 0;
      font-size: 1.5em;
    }

    .feed-item.update {
      background: #f9f9f9;
      padding: 15px;
      border-left: 3px solid #4CAF50;
    }

    .update-summary {
      font-style: italic;
      color: #666;
    }

    a {
      color: #0066cc;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .post-navigation {
      display: flex;
      justify-content: space-between;
      margin: 40px 0;
      padding: 20px 0;
      border-top: 1px solid #eee;
      border-bottom: 1px solid #eee;
    }

    .post-navigation .disabled {
      color: #ccc;
    }

    .pagination {
      text-align: center;
      margin: 40px 0;
      padding: 20px;
    }

    .pagination a {
      margin: 0 10px;
    }

    footer {
      margin-top: 60px;
      padding-top: 20px;
      border-top: 2px solid #eee;
      text-align: center;
      color: #666;
    }

    pre {
      background: #f4f4f4;
      padding: 15px;
      overflow-x: auto;
      border-radius: 3px;
    }

    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }

    pre code {
      padding: 0;
    }

    /* Code blocks with syntax highlighting */
    .highlight {
      border-radius: 6px;
      padding: 16px;
      overflow-x: auto;
    }

    .highlighter-rouge {
      margin-bottom: 1.5em;
    }

    pre {
      margin-bottom: 1.5em;
    }

    blockquote {
      border-left: 3px solid #ccc;
      margin: 1.5em 0;
      padding: 0.5em 0 0.5em 1.5em;
      color: #555;
      font-style: italic;
    }

    blockquote p {
      margin-bottom: 0;
    }

    /* Attribution line */
    article > p:last-child em {
      display: block;
      margin-top: 2em;
      color: #666;
    }

    /* Images in articles */
    article img {
      display: block;
      max-width: 90%;
      height: auto;
      margin: 1.5em auto;
    }

    /* Lists in articles */
    article ol,
    article ul {
      margin-left: 5%;
      margin-bottom: 1.5em;
    }

    article li {
      margin-bottom: 0.5em;
    }
  CSS

  # Add Rouge GitHub syntax highlighting theme
  css += "\n/* Syntax highlighting - GitHub theme */\n"
  css += Rouge::Themes::Github.render(scope: '.highlight')

  File.write("#{OUTPUT_DIR}/css/style.css", css)
end

def copy_assets
  if Dir.exist?("#{CONTENT_DIR}/assets")
    FileUtils.cp_r("#{CONTENT_DIR}/assets", OUTPUT_DIR)
  end
end

def generate_rss(feed)
  site_url = "https://ikigai.metaspot.org"

  items_xml = feed.first(20).map do |item|
    entry = item[:entry]
    pub_date = item[:date].strftime("%a, %d %b %Y 00:00:00 GMT")

    # Use slug as GUID for stability across rebuilds
    guid = "#{site_url}#{entry.url}"

    title = if item[:is_update]
      "Updated: #{entry.title}"
    else
      entry.title
    end

    description = if item[:is_update] && item[:update_summary]
      item[:update_summary]
    else
      entry.html.gsub(/<[^>]+>/, '').slice(0, 500) + "..."
    end

    <<~ITEM
      <item>
        <title>#{escape_xml(title)}</title>
        <link>#{guid}</link>
        <guid isPermaLink="true">#{guid}</guid>
        <pubDate>#{pub_date}</pubDate>
        <description>#{escape_xml(description)}</description>
      </item>
    ITEM
  end.join("\n")

  rss = <<~RSS
    <?xml version="1.0" encoding="UTF-8"?>
    <rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
      <channel>
        <title>Ikigai Devlog</title>
        <link>#{site_url}</link>
        <description>AI-assisted development journal</description>
        <language>en-us</language>
        <atom:link href="#{site_url}/feed.xml" rel="self" type="application/rss+xml"/>
        #{items_xml}
      </channel>
    </rss>
  RSS

  File.write("#{OUTPUT_DIR}/feed.xml", rss)
end

def escape_xml(text)
  text.to_s
    .gsub('&', '&amp;')
    .gsub('<', '&lt;')
    .gsub('>', '&gt;')
    .gsub('"', '&quot;')
    .gsub("'", '&apos;')
end

# Main build process
puts "Building ikigai-devlog..."

# Clean output directory
FileUtils.rm_rf(OUTPUT_DIR)
FileUtils.mkdir_p(OUTPUT_DIR)

# Load all entries
puts "Loading content..."
entries = load_entries
puts "  Found #{entries.length} entries"

# Build chronological feed
puts "Building feed..."
feed = build_feed(entries)

# Generate individual entry pages
puts "Generating entry pages..."
entries.each_with_index do |entry, idx|
  prev_entry = idx > 0 ? entries[idx - 1] : nil
  next_entry = idx < entries.length - 1 ? entries[idx + 1] : nil
  generate_entry_page(entry, prev_entry: prev_entry, next_entry: next_entry)
end

# Generate index and pagination pages
puts "Generating index pages..."
total_pages = (feed.length.to_f / POSTS_PER_PAGE).ceil
(1..total_pages).each do |page_num|
  generate_index_page(feed, page_num)
end

# Generate RSS feed
puts "Generating RSS feed..."
generate_rss(feed)

# Generate CSS
puts "Generating CSS..."
generate_css

# Copy assets
puts "Copying assets..."
copy_assets

puts "Build complete! Output in #{OUTPUT_DIR}/"
